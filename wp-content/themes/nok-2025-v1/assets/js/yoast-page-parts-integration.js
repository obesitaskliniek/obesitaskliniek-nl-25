(()=>{"use strict";const t=window.wp.data,e=window.wp.i18n;!function(){class o{constructor(){this.pluginName="nok-page-parts-analysis",this.isRegistered=!1,this.currentMode=null,window.nokPagePartData=window.nokPagePartData||{},this.init()}init(){if("undefined"!=typeof wp&&void 0!==wp.data){if(!this.isVisualMode())return this.showCodeModeNotice(),void this.watchForModeSwitch();this.currentMode="visual","undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app?this.waitForIframesAndRegister():jQuery(window).on("YoastSEO:ready",()=>this.waitForIframesAndRegister()),this.watchForModeSwitch()}else console.warn("[Yoast Page Parts] WordPress data module not available")}isVisualMode(){const e=(0,t.select)("core/edit-post")?.getEditorMode();return"visual"===e}showCodeModeNotice(){(0,t.dispatch)("core/notices").createInfoNotice((0,e.__)("Page Part SEO analysis is disabled in code editor mode. Switch to visual mode for full SEO analysis.","nok-2025-v1"),{id:"nok-yoast-code-mode",isDismissible:!0})}watchForModeSwitch(){let e=this.currentMode;wp.data.subscribe(()=>{const o=this.isVisualMode()?"visual":"code";o!==e&&(e=o,this.currentMode=o,"visual"!==o||this.isRegistered?"code"===o&&this.showCodeModeNotice():((0,t.dispatch)("core/notices").removeNotice("nok-yoast-code-mode"),this.waitForIframesAndRegister()))})}async waitForIframesAndRegister(){if("undefined"==typeof YoastSEO||void 0===YoastSEO.app)return void console.warn("[Yoast Page Parts] YoastSEO.app not available");YoastSEO.app.registerPlugin(this.pluginName,{status:"loading"});const t=window.nokYoastIntegration?.expectedParts||[];if(nokYoastIntegration.debug&&console.log("[Yoast Page Parts] Waiting for iframes:",t),0===t.length)return YoastSEO.app.pluginReady(this.pluginName),void this.completeRegistration();let e=0;const o=()=>{const e=Object.keys(window.nokPagePartData).map(t=>parseInt(t));return!!t.every(t=>e.includes(t))&&(nokYoastIntegration.debug&&console.log("[Yoast Page Parts] All iframes loaded"),YoastSEO.app.pluginReady(this.pluginName),this.completeRegistration(),!0)};if(o())return;const a=setInterval(()=>{e+=100,o()?clearInterval(a):e>=1e4&&(clearInterval(a),console.warn("[Yoast Page Parts] Timeout waiting for iframes, marking as ready with partial data"),YoastSEO.app.pluginReady(this.pluginName),this.completeRegistration())},100)}completeRegistration(){this.isRegistered||(YoastSEO.app.registerModification("content",this.modifyContent.bind(this),this.pluginName,10),this.isRegistered=!0,nokYoastIntegration.debug&&console.log("[Yoast Page Parts] Plugin registered with Yoast"),this.refreshYoastAnalysis(),this.watchForBlockChanges())}modifyContent(e){const o=(0,t.select)("core/block-editor")?.getBlocks()||[],a=this.findPagePartBlocks(o).filter(t=>!t.attributes?.excludeFromSeo);let s="";return a.forEach(t=>{const e=t.attributes?.postId;e&&window.nokPagePartData[e]&&(s+="\n\n"+window.nokPagePartData[e])}),nokYoastIntegration.debug&&s&&console.log(`[Yoast Page Parts] Adding ${s.length} characters from ${a.length} parts`),e+s}findPagePartBlocks(t){let e=[];for(const o of t)"nok2025/embed-nok-page-part"===o.name&&e.push(o),o.innerBlocks?.length>0&&(e=e.concat(this.findPagePartBlocks(o.innerBlocks)));return e}watchForBlockChanges(){let t=this.getBlockState();wp.data.subscribe(()=>{const e=this.getBlockState();JSON.stringify(e)!==JSON.stringify(t)&&(t=e,nokYoastIntegration.debug&&console.log("[Yoast Page Parts] Block structure changed, refreshing analysis"),this.refreshYoastAnalysis())})}getBlockState(){const e=(0,t.select)("core/block-editor")?.getBlocks()||[];return this.findPagePartBlocks(e).map(t=>({id:t.attributes?.postId||0,excluded:t.attributes?.excludeFromSeo||!1}))}refreshYoastAnalysis(){"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app&&"function"==typeof YoastSEO.app.refresh&&YoastSEO.app.refresh()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new o}):new o}()})();