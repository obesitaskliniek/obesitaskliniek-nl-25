(()=>{"use strict";const t=window.wp.data;!function(){class e{constructor(){this.pluginName="nok-page-parts-analysis",this.aggregatedContent="",this.isFetching=!1,this.fetchPromise=null,this.init()}init(){"undefined"!=typeof wp&&void 0!==wp.data?"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app?this.registerPlugin():jQuery(window).on("YoastSEO:ready",()=>this.registerPlugin()):console.warn("[Yoast Page Parts] WordPress data module not available")}async registerPlugin(){"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app?(console.log("[Yoast Page Parts] Pre-fetching content before registration..."),await this.fetchAggregatedContent(),YoastSEO.app.registerPlugin(this.pluginName,{status:"ready"}),YoastSEO.app.registerModification("content",this.modifyContent.bind(this),this.pluginName,10),console.log("[Yoast Page Parts] Plugin registered with preloaded content"),this.refreshYoastAnalysis(),this.watchForChanges()):console.warn("[Yoast Page Parts] YoastSEO.app not available")}modifyContent(t){return console.log(`[Yoast] ⏰ modifyContent called at ${(new Date).toISOString()}`),console.log("[Yoast] Original length:",t.length),console.log("[Yoast] Aggregated length:",this.aggregatedContent.length),this.aggregatedContent?t+"\n\n"+this.aggregatedContent:t}async fetchAggregatedContent(){if(this.isFetching)return this.fetchPromise;const e=this.getCurrentPostId();if(!e)return void console.warn("[Yoast Page Parts] No post ID available");const o=(0,t.select)("core/block-editor")?.getBlocks()||[],n=this.findPagePartBlocks(o).map(t=>t.attributes?.postId).filter(Boolean);return console.log("[Yoast Page Parts] Fetching with part IDs:",n),this.isFetching=!0,this.fetchPromise=fetch(`/wp-json/nok-2025-v1/v1/seo-content/${e}`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-WP-Nonce":wpApiSettings?.nonce||""},body:JSON.stringify({part_ids:n})}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).then(t=>{this.aggregatedContent=t.content||"",console.log(`[Yoast Page Parts] Fetched ${t.content_length} characters from ${t.part_count} parts`),this.refreshYoastAnalysis()}).catch(t=>{console.error("[Yoast Page Parts] Failed to fetch aggregated content:",t),this.aggregatedContent=""}).finally(()=>{this.isFetching=!1,this.fetchPromise=null}),this.fetchPromise}findPagePartBlocks(t){let e=[];for(const o of t)"nok2025/embed-nok-page-part"===o.name&&e.push(o),o.innerBlocks?.length>0&&(e=e.concat(this.findPagePartBlocks(o.innerBlocks)));return e}getCurrentPostId(){try{const e=(0,t.select)("core/editor")?.getCurrentPostId();return e||null}catch(t){return console.error("[Yoast Page Parts] Error getting post ID:",t),null}}watchForChanges(){let e=[],o=null;wp.data.subscribe(()=>{clearTimeout(o),o=setTimeout(()=>{const o=(0,t.select)("core/block-editor")?.getBlocks()||[],n=this.findPagePartBlocks(o).map(t=>t.attributes?.postId).filter(Boolean).sort();JSON.stringify(n)!==JSON.stringify(e)&&(console.log("[Yoast Page Parts] Part IDs changed:",{from:e,to:n}),setTimeout(()=>{const o=(0,t.select)("core/block-editor")?.getBlocks()||[],s=this.findPagePartBlocks(o).map(t=>t.attributes?.postId).filter(Boolean).sort();JSON.stringify(s)===JSON.stringify(n)?(e=n,console.log("[Yoast Page Parts] State stable, fetching content"),this.fetchAggregatedContent()):console.log("[Yoast Page Parts] State changed during verification, will retry")},300))},800)})}findPagePartBlocks(t){let e=[];for(const o of t)"nok2025/embed-nok-page-part"===o.name&&e.push(o),o.innerBlocks&&o.innerBlocks.length>0&&(e=e.concat(this.findPagePartBlocks(o.innerBlocks)));return e}countPagePartBlocks(t){let e=0;for(const o of t)"nok2025/embed-nok-page-part"===o.name&&e++,o.innerBlocks&&o.innerBlocks.length>0&&(e+=this.countPagePartBlocks(o.innerBlocks));return e}refreshYoastAnalysis(){"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app&&"function"==typeof YoastSEO.app.refresh&&YoastSEO.app.refresh()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new e}):new e}()})();