(()=>{"use strict";const t=window.wp.data;!function(){class e{constructor(){this.pluginName="nok-page-parts-analysis",this.aggregatedContent="",this.isFetching=!1,this.fetchPromise=null,this.init()}init(){"undefined"!=typeof wp&&void 0!==wp.data?"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app?this.registerPlugin():jQuery(window).on("YoastSEO:ready",()=>this.registerPlugin()):console.warn("[Yoast Page Parts] WordPress data module not available")}registerPlugin(){"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app?(YoastSEO.app.registerPlugin(this.pluginName,{status:"ready"}),YoastSEO.app.registerModification("content",this.modifyContent.bind(this),this.pluginName,10),console.log("[Yoast Page Parts] Plugin registered successfully"),this.fetchAggregatedContent(),this.watchForChanges()):console.warn("[Yoast Page Parts] YoastSEO.app not available")}modifyContent(t){return console.log(`[Yoast] â° modifyContent called at ${(new Date).toISOString()}`),console.log("[Yoast] Original length:",t.length),console.log("[Yoast] Aggregated length:",this.aggregatedContent.length),this.aggregatedContent?t+"\n\n"+this.aggregatedContent:t}async fetchAggregatedContent(){if(this.isFetching)return this.fetchPromise;const t=this.getCurrentPostId();if(t)return this.isFetching=!0,this.fetchPromise=fetch(`/wp-json/nok-2025-v1/v1/seo-content/${t}?use_cache=true`,{credentials:"same-origin",headers:{"X-WP-Nonce":wpApiSettings?.nonce||""}}).then(t=>{if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);return t.json()}).then(t=>{this.aggregatedContent=t.content||"",console.log(`[Yoast Page Parts] Fetched ${t.content_length} characters from ${t.part_count} parts`),this.refreshYoastAnalysis()}).catch(t=>{console.error("[Yoast Page Parts] Failed to fetch aggregated content:",t),this.aggregatedContent=""}).finally(()=>{this.isFetching=!1,this.fetchPromise=null}),this.fetchPromise;console.warn("[Yoast Page Parts] No post ID available")}getCurrentPostId(){try{const e=(0,t.select)("core/editor")?.getCurrentPostId();return e||null}catch(t){return console.error("[Yoast Page Parts] Error getting post ID:",t),null}}watchForChanges(){let e=0,n=null;wp.data.subscribe(()=>{const o=(0,t.select)("core/block-editor")?.getBlocks()||[],s=this.countPagePartBlocks(o);s!==e&&(e=s,clearTimeout(n),n=setTimeout(()=>{console.log("[Yoast Page Parts] Block count changed, refreshing content..."),this.fetchAggregatedContent()},1e3))})}countPagePartBlocks(t){let e=0;for(const n of t)"nok2025/embed-nok-page-part"===n.name&&e++,n.innerBlocks&&n.innerBlocks.length>0&&(e+=this.countPagePartBlocks(n.innerBlocks));return e}refreshYoastAnalysis(){"undefined"!=typeof YoastSEO&&void 0!==YoastSEO.app&&"function"==typeof YoastSEO.app.refresh&&YoastSEO.app.refresh()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new e}):new e}()})();