import{logger}from"./domule/core.log.mjs";export const NAME="aos";const DEFAULTS={selector:"[data-aos]",dataName:"visible",offset:120,once:false,mirror:false,anchorPlacement:"top-bottom",disableMutationObserver:false,threshold:.1};const THRESHOLD_STEPS=101;const MAX_THRESHOLD_RATIO=.99;const ELEMENT_NODE=1;const thresholdCache=new WeakMap;let globalInstance=null;function parseThreshold(value){return typeof value==="string"&&value.endsWith("%")?parseFloat(value)/100:parseFloat(value)}function getElementThreshold(el,
defaultThreshold){if(!thresholdCache.has(el)){const value=el.dataset.aosThreshold??defaultThreshold;thresholdCache.set(el,parseThreshold(value))}return thresholdCache.get(el)}function initElement(el,options){el.classList.add("nok-aos");el.dataset[options.dataName]="false";if(!el.dataset.aosOnce)el.dataset.aosOnce=String(options.once)}function calculateEffectiveThreshold(requestedThreshold,viewportHeight,elementHeight){const maxRatio=Math.min(1,viewportHeight/elementHeight);return Math.min(requestedThreshold,
maxRatio*MAX_THRESHOLD_RATIO)}class AOS{constructor(options={}){this.options={...DEFAULTS,...options};this.elements=[];this.observer=null;this.mutationObserver=null;this.initialized=false}init(){if(this.initialized){logger.warn(NAME,"Already initialized");return}this.elements=Array.from(document.querySelectorAll(this.options.selector));if(!this.elements.length){logger.info(NAME,"No elements found");return}this.elements.forEach(el=>initElement(el,this.options));this._setupIntersectionObserver();if(!this.options.disableMutationObserver)this._setupMutationObserver();
this.initialized=true;logger.info(NAME,`Tracking ${this.elements.length} element(s)`)}_setupIntersectionObserver(){this.observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{const el=entry.target;const requestedThreshold=getElementThreshold(el,this.options.threshold);const effectiveThreshold=calculateEffectiveThreshold(requestedThreshold,entry.rootBounds?.height??window.innerHeight,entry.boundingClientRect.height);if(entry.intersectionRatio>=effectiveThreshold)el.dataset[this.options.dataName]=
"true";else if(this.options.mirror&&el.dataset.aosOnce!=="true")el.dataset[this.options.dataName]="false"})},{rootMargin:this._calculateRootMargin(),threshold:Array.from({length:THRESHOLD_STEPS},(_,i)=>i/(THRESHOLD_STEPS-1))});this.elements.forEach(el=>this.observer.observe(el))}_setupMutationObserver(){this.mutationObserver=new MutationObserver(mutations=>{mutations.forEach(mutation=>{mutation.addedNodes.forEach(node=>{if(node.nodeType!==ELEMENT_NODE)return;if(node.matches(this.options.selector))this._addElement(node);
node.querySelectorAll(this.options.selector).forEach(el=>this._addElement(el))})})});this.mutationObserver.observe(document.body,{childList:true,subtree:true})}_addElement(el){if(this.elements.includes(el))return;initElement(el,this.options);this.elements.push(el);this.observer?.observe(el);logger.info(NAME,"Added dynamic element")}_calculateRootMargin(){const [anchor,placement]=this.options.anchorPlacement.split("-");const offset=this.options.offset;return`${anchor==="top"?offset:0}px 0px ${placement===
"bottom"?offset:0}px 0px`}refresh(){this.observer?.disconnect();this.elements=Array.from(document.querySelectorAll(this.options.selector));this._setupIntersectionObserver();logger.info(NAME,"Refreshed")}refreshHard(){this.destroy();this.init()}destroy(){this.observer?.disconnect();this.mutationObserver?.disconnect();this.elements.forEach(el=>{delete el.dataset[this.options.dataName];thresholdCache.delete(el)});this.elements=[];this.initialized=false;logger.info(NAME,"Destroyed")}}export function init(elements){if(globalInstance){logger.warn(NAME,
'Global instance exists, use api("refresh")');return"Already initialized"}const firstEl=elements[0];const options=firstEl?{selector:firstEl.dataset.aosSelector||DEFAULTS.selector,once:firstEl.dataset.aosOnce==="true",mirror:firstEl.dataset.aosMirror==="true",offset:parseInt(firstEl.dataset.aosOffset)||DEFAULTS.offset,threshold:firstEl.dataset.aosThreshold||DEFAULTS.threshold}:{};globalInstance=new AOS(options);if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>globalInstance.init());
else globalInstance.init();return`Initialized with ${elements.length} container(s)`}export function api(action,...args){if(!globalInstance){logger.warn(NAME,"Not initialized");return null}switch(action){case "refresh":globalInstance.refresh();break;case "refreshHard":globalInstance.refreshHard();break;case "getElements":return globalInstance.elements;case "isTracking":return args[0]?globalInstance.elements.includes(args[0]):false;default:logger.warn(NAME,`Unknown action: ${action}`);return null}}export function destroy(){if(globalInstance){globalInstance.destroy();
globalInstance=null}}export default{init(options={}){const aos=new AOS(options);logger.info(NAME,"Standalone instance initialized.");if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>aos.init());else aos.init();return aos}};
