(()=>{"use strict";const e=window.wp.data,t=window.wp.plugins,s=window.wp.editPost,i=window.wp.components,a=new class{constructor(e,t,s,i,a,r){this.startdeg=i||0,this.degsteps=e||60,this.startsat=t||100,this.startbri=s||100,this.gradsteps=a&&a>1?a:10,this.paletlim=r||[0,360],this.skipgreen=!1,this.calls=0,this.color=null,this.deg=0,this.cyc=0,this.bri=100,this.sat=100,this.opa=1}_stringToDegrees(e){let t=[...e].reduce((e,t)=>t.charCodeAt(0)+((e<<5)-e),0);return Math.abs(t)%360}_textContrast(e){return Math.round((299*parseInt(e[0])+587*parseInt(e[1])+114*parseInt(e[2]))/1e3)>125?"rgb(0,0,0)":"rgb(255,255,255)"}_componentToHex(e){var t=e.toString(16);return 1===t.length?"0"+t:t}_rgbToHex(e){return"#"+this._componentToHex(e[0])+this._componentToHex(e[1])+this._componentToHex(e[2])}_hexToRgb(e){return e.match(/\w\w/g).map(e=>+`0x${e}`)}_hexToHSL(e){let t=this._hexToRgb(e),s=t[0]/255,i=t[1]/255,a=t[2]/255,r=Math.min(s,i,a),o=Math.max(s,i,a),n=o-r,l=0,d=0,h=0;return l=0===n?0:o===s?(i-a)/n%6:o===i?(a-s)/n+2:(s-i)/n+4,l=Math.round(60*l),l<0&&(l+=360),h=(o+r)/2,d=0===n?0:n/(1-Math.abs(2*h-1)),d=+(100*d).toFixed(1),h=+(100*h).toFixed(1),[l,d,h]}_hsl2hsv(e){const t=e[1]*(e[2]<50?e[2]:100-e[2])/100,s=0===t?0:2*t/(e[2]+t)*100,i=e[2]+t;return[e[0],s,i]}_HSVtoRGB(e,t,s,i){var a,r,o,n,l,d,h,c;switch(e/=360,t/=100,s/=100,i=void 0!==i?parseFloat(i):void 0,1===arguments.length&&(t=e.s,s=e.v,e=e.h),d=s*(1-t),h=s*(1-(l=6*e-(n=Math.floor(6*e)))*t),c=s*(1-(1-l)*t),n%6){case 0:a=s,r=c,o=d;break;case 1:a=h,r=s,o=d;break;case 2:a=d,r=s,o=c;break;case 3:a=d,r=h,o=s;break;case 4:a=c,r=d,o=s;break;case 5:a=s,r=d,o=h}let p=[Math.round(255*a),Math.round(255*r),Math.round(255*o)],g="rgb";return void 0!==i&&(p.push(i),g="rgba"),{values:p,string:g+"("+p.join(",")+")",hex:this._rgbToHex(p),contra:this._textContrast(p),textContrast:this._textContrast}}doColor(e,t){let s=!1;if("string"==typeof e)if("#"===e[0]){let t=this._hsl2hsv(this._hexToHSL(e));this.deg=t[0],this.sat=t[1],this.bri=t[2],s=!0}else this.deg=this._stringToDegrees(e);else this.startdeg=this.startdeg<this.paletlim[0]?this.paletlim[0]:this.startdeg,this.deg=this.startdeg+this.calls*this.degsteps;if(this.cyc=Math.floor(this.deg/this.paletlim[1]),!s&&(this.bri=e&&e>0?e:this.startbri,this.sat=t&&t>0?t:this.startsat,this.bri=Math.abs(this.bri%101),this.sat=Math.abs(this.sat%101),this.deg=this.deg%(this.paletlim[1]+1),this.deg=this.deg<this.paletlim[0]?this.paletlim[0]:this.deg,this.paletlim[0]%this.degsteps===0&&this.cyc>0)){let s=this.cyc*this.gradsteps;this.altbri=e&&e>0?e:this.startbri-s,this.altsat=t&&t>0?t:this.startsat-s,this.altdeg=this.deg+this.degsteps/(this.cyc+1),this.altdeg=this.altdeg<this.paletlim[0]?this.altdeg-this.paletlim[0]:this.altdeg,this.bri=this.altbri,s>=100&&(this.cyc=0,this.gradsteps=this.gradsteps/2)}return this._HSVtoRGB(this.deg,this.sat,this.bri)}new(e,t){return this.color=this.doColor(e,t),this.string=this.color.string,this.values=this.color.values,this.contra=this.color.contra,this.hex=this._rgbToHex(this.color.values),this.calls++,this}adjust(e){let t,s,i,a,r=void 0!==e.deg?e.deg:0,o=void 0!==e.sat?e.sat:this.sat,n=void 0!==e.bri?e.bri:this.bri,l=void 0!==e.opa?e.opa:this.opa;return i=(this.deg+r)%this.paletlim[1],s=n<=1&&n>0?this.bri*n:n,t=o<=1&&o>0?this.sat*o:o,a=l<0?0:l>1?1:l,s=s>100?100:s<0?0:s,t=t>100?100:t<0?0:t,this._HSVtoRGB(i,t,s,a)}},r=window.location.search.includes("debug=true");function o(e){return"%c"+[].slice.call(e).join("%c")}const n="font-family: Lucida Grande,Lucida Sans Unicode,Lucida Sans,Geneva,Verdana,sans-serif";function l(e){const t=a.new(e);return`color:${t.contra};\n  background-color:${t.string};\n  background-image:linear-gradient(0deg,${t.adjust({deg:10}).string} 0%, ${t.adjust({opa:1}).string} 100%);\n  padding:3px 5px;margin-right:15px;border-radius:4px;`}const d=function(e,t){!r||console.log("object"==typeof e?e:o("object"==typeof t?[e]:arguments),`${n}; ${l(e)}`,"object"==typeof t?t:`${n};color:black;`)},h=window.wp.element,c=window.ReactJSXRuntime,p="nok-page-part-design-selector",g=({field:e,schema:t,value:s,onChange:i})=>{const[a,r]=(0,h.useState)(()=>{try{return JSON.parse(s||"[]")}catch{return[]}}),o=()=>{const e={};return t.forEach(t=>{e[t.name]=""}),e},n=e=>{r(e),i(JSON.stringify(e))},l=(e,t,s)=>{const i=[...a];i[e]={...i[e],[t]:s},n(i)};return(0,c.jsxs)("div",{style:{border:"1px solid #ddd",borderRadius:"4px",padding:"12px",marginTop:"8px"},children:[(0,c.jsx)("div",{style:{marginBottom:"12px",fontSize:"13px",fontWeight:"600"},children:e.label}),a.map((e,s)=>(0,c.jsxs)("div",{style:{border:"1px solid #e0e0e0",borderRadius:"4px",marginBottom:"10px",overflow:"hidden"},children:[(0,c.jsxs)("div",{style:{background:"#f8f9fa",padding:"8px 12px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid #e0e0e0"},children:[(0,c.jsxs)("span",{style:{fontSize:"12px",fontWeight:"600"},children:["Item ",s+1]}),(0,c.jsx)("button",{type:"button",onClick:()=>(e=>{const t=a.filter((t,s)=>s!==e);n(t)})(s),style:{background:"none",border:"none",color:"#d63638",cursor:"pointer",fontSize:"12px"},children:"Remove"})]}),(0,c.jsx)("div",{style:{padding:"12px"},children:t.map(t=>((e,t,s)=>{const i=e.name,a=t[i]||"",r=e.name.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),o={width:"100%",padding:"6px 8px",border:"1px solid #ddd",borderRadius:"3px",fontSize:"13px"};switch(e.type){case"textarea":return(0,c.jsxs)("div",{style:{marginBottom:"8px"},children:[(0,c.jsxs)("label",{style:{display:"block",fontSize:"11px",fontWeight:"600",marginBottom:"4px"},children:[r,":"]}),(0,c.jsx)("textarea",{value:a,onChange:e=>l(s,i,e.target.value),rows:"3",style:{...o,resize:"vertical"}})]},i);case"url":return(0,c.jsxs)("div",{style:{marginBottom:"8px"},children:[(0,c.jsxs)("label",{style:{display:"block",fontSize:"11px",fontWeight:"600",marginBottom:"4px"},children:[r,":"]}),(0,c.jsx)("input",{type:"url",value:a,onChange:e=>l(s,i,e.target.value),placeholder:"https://...",style:o})]},i);default:return(0,c.jsxs)("div",{style:{marginBottom:"8px"},children:[(0,c.jsxs)("label",{style:{display:"block",fontSize:"11px",fontWeight:"600",marginBottom:"4px"},children:[r,":"]}),(0,c.jsx)("input",{type:"text",value:a,onChange:e=>l(s,i,e.target.value),style:o})]},i)}})(t,e,s))})]},s)),(0,c.jsx)("button",{type:"button",onClick:()=>{const e=[...a,o()];n(e)},style:{background:"#0073aa",color:"white",border:"none",padding:"6px 12px",borderRadius:"3px",cursor:"pointer",fontSize:"12px"},children:"Add Item"})]})};(0,t.registerPlugin)("page-part-design",{render:function(){if("page_part"!==(0,e.useSelect)(e=>e("core/editor").getCurrentPostType(),[]))return null;const t=(0,e.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),a=(0,e.useSelect)(e=>e("core/editor").getEditedPostAttribute("meta"),[]),{editPost:u}=(0,e.useDispatch)("core/editor"),x=window.PagePartDesignSettings?.registry||{},m=[{label:"— Select —",value:""},...Object.entries(x).map(([e,t])=>({label:t.name,value:e}))],b=a?.design_slug||"",f=(x[b]||{}).custom_fields||[],y=(e=null)=>{const s=e||a,i=s?.design_slug||"";d(p,"Storing all meta:"),d(p,s);const h=new URLSearchParams({action:"store_preview_state",post_id:t,design_slug:i});h.append("all_meta",JSON.stringify(s)),fetch(window.PagePartDesignSettings.ajaxurl,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:h}).then(e=>e.json()).then(e=>(d(p,"Meta stored via React:"),d(p,e),wp.data.dispatch("core/editor").autosave())).then(()=>{d(p,"Autosave completed via React"),"function"==typeof window.nokUpdatePreview&&window.nokUpdatePreview(!0)}).catch(e=>{!function(e,t){!r||console.error("object"==typeof e?e:o("object"==typeof t?[e]:arguments),`${n}; ${l(e)}`,"object"==typeof t?t:`${n};color:red;`)}(p,`Preview update failed: ${e}`)})},[v,_]=(0,h.useState)({}),[w,j]=(0,h.useState)(!1),k=(0,h.useRef)({});(0,h.useEffect)(()=>{if(a&&f.length>0){const e={};f.forEach(t=>{const s=a[t.meta_key],i=void 0!==s&&""!==s?s:t.default||"";e[t.meta_key]=i}),_(e),w||setTimeout(()=>j(!0),1e3)}},[b,a?.design_slug]);const S=(e,t)=>{w?(_(s=>({...s,[e]:t})),k.current[e]&&clearTimeout(k.current[e]),k.current[e]=setTimeout(()=>{d(p,`Debounced update for ${e}: ${t}`);const s={...a,[e]:t};u({meta:s}),y(s),delete k.current[e]},500)):d(p,`Skipping update during initialization for ${e}`)};return(0,c.jsxs)(s.PluginDocumentSettingPanel,{name:"page-part-design",title:"NOK Design template",children:[(0,c.jsx)(i.SelectControl,{label:"Template",value:b,options:m,onChange:e=>{d(p,`→ setting design_slug to "${e}"`);const t={...a,design_slug:e};u({meta:t}),y(t)}}),f.length>0&&(0,c.jsxs)(h.Fragment,{children:[(0,c.jsx)("hr",{style:{margin:"16px 0"}}),(0,c.jsx)("h4",{style:{margin:"0 0 12px 0",fontSize:"13px",fontWeight:"600"},children:"Template options"}),f.map(e=>{var t,s;const r=null!==(t=null!==(s=v[e.meta_key])&&void 0!==s?s:a?.[e.meta_key])&&void 0!==t?t:"";switch(e.type){case"textarea":return(0,c.jsx)(i.TextareaControl,{label:e.label,value:r,onChange:t=>S(e.meta_key,t),rows:3},e.meta_key);case"url":return(0,c.jsx)(i.TextControl,{label:e.label,type:"url",value:r,onChange:t=>S(e.meta_key,t),placeholder:"https://..."},e.meta_key);case"repeater":return e.schema&&0!==e.schema.length?(0,c.jsx)(g,{field:e,schema:e.schema,value:r,onChange:t=>S(e.meta_key,t)},e.meta_key):(0,c.jsxs)("div",{style:{padding:"12px",background:"#fff3cd",border:"1px solid #ffc107",borderRadius:"4px"},children:[(0,c.jsx)("strong",{children:"Warning:"}),' Repeater field "',e.label,'" has no schema defined.']},e.meta_key);case"select":const t=e.options||[],s=e.option_labels||t;return(0,c.jsx)(i.SelectControl,{label:e.label,value:r,options:[{label:"— Select —",value:""},...t.map((e,t)=>({label:s[t]||e,value:e}))],onChange:t=>S(e.meta_key,t)},e.meta_key);case"checkbox":return(0,c.jsx)(i.CheckboxControl,{label:e.label,checked:"1"===r||!0===r,onChange:t=>S(e.meta_key,t?"1":"0")},e.meta_key);default:return(0,c.jsx)(i.TextControl,{label:e.label,value:r,onChange:t=>S(e.meta_key,t)},e.meta_key)}})]})]})}})})();